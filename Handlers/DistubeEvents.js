import { autoresume, music as musicDB } from "../Events/Assets/Schemas/databases.js";
import { EmbedBuilders, classComponent, addComponents } from "../Events/functions.js";
import { EmbedBuilder, ChannelType } from "discord.js";
import { Song, SearchResultVideo } from "distube";
import lyricsFinder from "lyrics-finder";
import colors from "chalk";
// 
const cls = new classComponent();
const playerintervals = new Map();
const PlayerMap = new Map();
let songEditInterval = null;
let lastEdited = false;

// Music embed
export const musicEmbedDefault = (client, guilds) => {
  const guild = client.guilds.cache.get(guilds.id);
  const genshinGif = [
    "https://upload-os-bbs.hoyolab.com/upload/2021/08/12/64359086/ad5f51c6a4f16adb0137cbe1e86e165d_8637324071058858884.gif?x-oss-process=image/resize,s_1000/quality,q_80/auto-orient,0/interlace,1/format,gif",
  ];
  const randomGenshin = genshinGif[Math.floor(Math.random() * genshinGif.length)];
  var playlistName = [`Gaming`, `NCS | No Copyright Music`];
  var Emojis = [`0Ô∏è‚É£`, `1Ô∏è‚É£`];
  return {
    embeds: [
      new EmbedBuilders({
        description: `**Hi·ªán t·∫°i c√≥ __0 B√†i h√°t__ trong H√†ng ƒë·ª£i**`,
        title: { name: `üìÉ h√†ng ƒë·ª£i c·ªßa __${guild.name}__` },
        thumbnail: guild.iconURL({ dynamic: true }),
        colors: "Random",
      }),
      new EmbedBuilders({
        title: { name: `B·∫Øt ƒë·∫ßu nghe nh·∫°c, b·∫±ng c√°ch k·∫øt n·ªëi v·ªõi K√™nh voice v√† g·ª≠i **LI√äN K·∫æT B√ÄI H√ÅT** ho·∫∑c **T√äN B√ÄI H√ÅT** trong K√™nh n√†y!` },
        description: `> *T√¥i h·ªó tr·ª£ Youtube, Spotify, Soundcloud v√† c√°c li√™n k·∫øt MP3 tr·ª±c ti·∫øp!*`,
        footer: { text: guild.name, iconURL: guild.iconURL({ dynamic: true }) },
        images: randomGenshin,
        colors: "Random"
      })
    ],
    components: addComponents({
      type: "SelectMenuBuilder",
      options: {
        placeholder: "Vui l√≤ng l·ª±a ch·ªçn m·ª•c theo y√™u c·∫ßu",
        customId: "StringSelectMenuBuilder",
        // minValues: 1, maxValues: 2,
        options: [playlistName.map((t, index) => {
          return {
            label: t.substring(0, 25), // tr√≠ch xu·∫•t t·ª´ 0 ƒë·∫øn 25 t·ª´ 
            value: t.substring(0, 25), // tr√≠ch xu·∫•t t·ª´ 0 ƒë·∫øn 25 t·ª´
            description: `T·∫£i Danh s√°ch ph√°t nh·∫°c: '${t}'`.substring(0, 50),  // tr√≠ch xu·∫•t t·ª´ 0 ƒë·∫øn 50 t·ª´
            emoji: Emojis[index], // th√™m emoji cho t·ª´ng c·ª•m t·ª´ 
            default: false // l·ª±a ch·ªçn m·∫∑c ƒë·ªãnh
          };
        })]
      }
    }, {
      type: "ButtonBuilder",
      options: [
        { style: "Primary", customId: "1", emoji: "‚è≠", label: "Skip", disabled: true },
        { style: "Danger", customId: "2", emoji: "üè†", label: "Stop", disabled: true },
        { style: "Secondary", customId: "3", emoji: "‚è∏", label: "Pause", disabled: true },
        { style: "Success", customId: "4", emoji: "üîÅ", label: "Autoplay", disabled: true },
        { style: "Primary", customId: "5", emoji: "üîÄ", label: "Shuffle", disabled: true },
      ]
    }, {
      type: "ButtonBuilder",
      options: [
        { style: "Success", customId: "6", emoji: "üîÅ", label: "Song", disabled: true },
        { style: "Success", customId: "7", emoji: "üîÇ", label: "Queue", disabled: true },
        { style: "Primary", customId: "8", emoji: "‚è©", label: "+10 Sec", disabled: true },
        { style: "Primary", customId: "9", emoji: "‚è™", label: "-10 Sec", disabled: true },
        { style: "Primary", customId: "10", emoji: "üìù", label: "Lyrics", disabled: true },
      ]
    })
  };
};

// t·∫°o embed b√†i h√°t
const receiveQueueData = (newQueue, newTrack, queue) => {
  if (!newQueue) return new EmbedBuilders({ color: "Random", title: { name: "Kh√¥ng th·ªÉ t√¨m ki·∫øm b√†i h√°t" } });
  if (!newTrack) return new EmbedBuilders({ color: "Random", title: { name: "Kh√¥ng th·ªÉ t√¨m ki·∫øm b√†i h√°t" } });
  // l·∫•y d·ªØ li·ªáu request roles
  const embeds = new EmbedBuilders({
    author: { name: `${newTrack.name}`, iconURL: "https://i.pinimg.com/originals/ab/4d/e0/ab4de08ece783245be1fb1f7fde94c6f.gif", url: newTrack.url },
    images: `https://img.youtube.com/vi/${newTrack.id}/mqdefault.jpg`,
    timestamp: Date.now(),
    color: "Random",
    fields: [
      { name: `Th·ªùi l∆∞·ª£ng:`, value: `>>> \`${newQueue.formattedCurrentTime} / ${newTrack.formattedDuration}\``, inline: true },
      { name: `H√†ng ch·ªù:`, value: `>>> \`${newQueue.songs.length} b√†i h√°t\`\n\`${newQueue.formattedDuration}\``, inline: true },
      { name: `√Çm l∆∞·ª£ng:`, value: `>>> \`${newQueue.volume} %\``, inline: true },
      { name: `v√≤ng l·∫∑p:`, value: `>>> ${newQueue.repeatMode ? newQueue.repeatMode === 2 ? `‚úîÔ∏è h√†ng ch·ªù` : `‚úîÔ∏è B√†i h√°t` : `‚ùå`}`, inline: true },
      { name: `T·ª± ƒë·ªông ph√°t:`, value: `>>> ${newQueue.autoplay ? `‚úîÔ∏è` : `‚ùå`}`, inline: true },
      { name: `Filters:`, value: `\`${newQueue.filters.names.join(", ") || "T·∫Øt"}\``, inline: true },
      { name: `T·∫£i nh·∫°c v·ªÅ:`, value: `>>> [Click v√†o ƒë√¢y](${newTrack.streamURL})`, inline: true },
      { name: `L∆∞·ª£t xem:`, value: `${Intl.NumberFormat().format(newQueue.songs[0].views)}`, inline: true },
      { name: `Likes`, value: `üëç ${Intl.NumberFormat().format(newQueue.songs[0].likes)}`, inline: true },
      { name: `Dislikes`, value: `üëé ${Intl.NumberFormat().format(newQueue.songs[0].dislikes)}`, inline: true },
    ]
  });
  // kh·ªüi t·∫°o c√°c n√∫t ph·∫£n ·ª©ng
  const components = addComponents({
    type: "ButtonBuilder",
    options: [
      { customId: "skip", style: cls.toButtonStyle("Primary"), emoji: "‚è≠", label: "B·ªè qua", disabled: false },
      { customId: "stop", style: cls.toButtonStyle("Danger"), emoji: "üõë", label: "D·ª´ng ph√°t", disabled: false },
      { customId: "pause", style: cls.toButtonStyle("Success"), emoji: "‚è∏", label: "T·∫°m d·ª´ng", disabled: false },
      { customId: "autoplay", style: cls.toButtonStyle("Success"), emoji: "üß≠", label: "T·ª± ƒë·ªông ph√°t", disabled: false },
      { customId: "shuffle", style: cls.toButtonStyle("Primary"), emoji: "üîÄ", label: "X√°o tr·ªôn", disabled: false },
    ],
  }, {
    type: "ButtonBuilder",
    options: [
      { customId: "song", style: cls.toButtonStyle("Success"), emoji: "üîÅ", label: "B√†i h√°t", disabled: false },
      { customId: "queue", style: cls.toButtonStyle("Success"), emoji: "üîÇ", label: "H√†ng ch·ªù", disabled: false },
      { customId: "seek", style: cls.toButtonStyle("Primary"), emoji: "‚è©", label: "+10 Gi√¢y", disabled: false },
      { customId: "seek2", style: cls.toButtonStyle("Primary"), emoji: "‚è™", label: "-10 Gi√¢y", disabled: false },
      { customId: "lyrics", style: cls.toButtonStyle("Primary"), emoji: "üìù", label: "L·ªùi nh·∫°c", disabled: false },
    ],
  }, {
    type: "ButtonBuilder",
    options: [
      { customId: "volumeUp", style: cls.toButtonStyle("Primary"), emoji: "üîä", label: "+10", disabled: false },
      { customId: "volumeDown", style: cls.toButtonStyle("Primary"), emoji: "üîâ", label: "-10", disabled: false },
    ],
  });
  if (!newQueue.playing) {
    components[0].components[2].setStyle(cls.toButtonStyle("Success")).setEmoji('‚ñ∂Ô∏è').setLabel(`Ti·∫øp t·ª•c`);
  } else if (newQueue.autoplay) {
    components[0].components[3].setStyle(cls.toButtonStyle("Secondary"));
  } else if (newQueue.repeatMode === 0) {
    components[1].components[0].setStyle(cls.toButtonStyle("Success"));
    components[1].components[1].setStyle(cls.toButtonStyle("Success"));
  } else if (newQueue.repeatMode === 1) {
    components[1].components[0].setStyle(cls.toButtonStyle("Secondary"));
    components[1].components[1].setStyle(cls.toButtonStyle("Success"));
  } else if (newQueue.repeatMode === 2) {
    components[1].components[0].setStyle(cls.toButtonStyle("Success"));
    components[1].components[1].setStyle(cls.toButtonStyle("Secondary"));
  };
  if (Math.floor(newQueue.currentTime) < 10) {
    components[1].components[3].setDisabled(true);
  } else {
    components[1].components[3].setDisabled(false);
  };
  if (Math.floor((newTrack.duration - newQueue.currentTime)) <= 10) {
    components[1].components[2].setDisabled(true);
  } else {
    components[1].components[2].setDisabled(false);
  };
  return { embeds: [embeds], components: components };
};
// t·∫°o h√†ng ƒë·ª£i embed 
const generateQueueEmbed = (client, guildId, leave) => {
  // t√¨m ki·∫øm guilds
  let guild = client.guilds.cache.get(guildId);
  if (!guild) return; // n·∫øu kh√¥ng th·∫•y guilds, return 
  let newQueue = client.distube.getQueue(guild.id); // t√¨m ki·∫øm h√†ng ƒë·ª£i 
  // m·ªëc t√≠nh th·ªùi gian 
  const createBar = (total, current, size = 25, line = "‚ñ¨", slider = "‚è≥") => {
    if (!total) return;
    if (!current) return `**[${slider}${line.repeat(size - 1)}]**`;
    let bar = current > total ? [line.repeat(size / 2 * 2), (current / total) * 100] : [line.repeat(Math.round(size / 2 * (current / total))).replace(/.$/, slider) + line.repeat(size - Math.round(size * (current / total)) + 1), current / total];
    if (!String(bar).includes(slider)) {
      return `**[${slider}${line.repeat(size - 1)}]**`;
    } else {
      return `**[${bar[0]}]**`;
    };
  };
  // gif ch·ªù ch·∫°y nh·∫°c
  const genshinGif = [
    "https://upload-os-bbs.hoyolab.com/upload/2021/08/12/64359086/ad5f51c6a4f16adb0137cbe1e86e165d_8637324071058858884.gif?x-oss-process=image/resize,s_1000/quality,q_80/auto-orient,0/interlace,1/format,gif",
    "https://upload-os-bbs.hoyolab.com/upload/2021/08/12/64359086/2fc26b1deefa6d2ff633dda1718d6e5b_6343886487912626448.gif?x-oss-process=image/resize,s_1000/quality,q_80/auto-orient,0/interlace,1/format,gif",
  ];
  // kh·ªüi t·∫°o embeds 
  var embeds = [
    new EmbedBuilders({
      description: "**Hi·ªán t·∫°i c√≥ 0 B√†i h√°t trong H√†ng ƒë·ª£i**",
      title: { name: `üìÉ h√†ng ƒë·ª£i c·ªßa __${guild.name}__` },
      thumbnail: guild.iconURL({ dynamic: true }),
      colors: "Random",
      fields: [
        { name: "B·∫Øt ƒë·∫ßu nghe nh·∫°c, b·∫±ng c√°ch k·∫øt n·ªëi v·ªõi K√™nh voice v√† g·ª≠i __li√™n k·∫øt b√†i h√°t__ ho·∫∑c __t√™n b√†i h√°t__ trong K√™nh n√†y!", value: "\u200B" },
        { name: "T√¥i h·ªó tr·ª£ __youtube-url__, __Spotify__, __SoundCloud__ v√† c√°c __mp3__ tr·ª±c ti·∫øp ...", value: "\u200B" },
      ]
    }),
    new EmbedBuilders({ footer: { text: guild.name, iconURL: guild.iconURL({ dynamic: true }) }, images: genshinGif[Math.floor(Math.random() * genshinGif.length)], colors: "Random" })
  ];
  // t·∫°o components
  var playlistName = [`Gaming`, `NCS | No Copyright Music`];
  var Emojis = [`0Ô∏è‚É£`, `1Ô∏è‚É£`];
  const menuOptions = {
    type: "SelectMenuBuilder",
    options: {
      placeholder: "Vui l√≤ng l·ª±a ch·ªçn m·ª•c theo y√™u c·∫ßu",
      customId: "StringSelectMenuBuilder",
      // minValues: 1, maxValues: 2,
      options: [playlistName.map((t, index) => {
        return {
          label: t.substring(0, 25), // tr√≠ch xu·∫•t t·ª´ 0 ƒë·∫øn 25 t·ª´ 
          value: t.substring(0, 25), // tr√≠ch xu·∫•t t·ª´ 0 ƒë·∫øn 25 t·ª´
          description: `T·∫£i Danh s√°ch ph√°t nh·∫°c: '${t}'`.substring(0, 50),  // tr√≠ch xu·∫•t t·ª´ 0 ƒë·∫øn 50 t·ª´
          emoji: Emojis[index], // th√™m emoji cho t·ª´ng c·ª•m t·ª´ 
          default: false // l·ª±a ch·ªçn m·∫∑c ƒë·ªãnh
        };
      })]
    }
  };
  const button1 = {
    type: "ButtonBuilder",
    options: [
      { customId: "Stop", style: cls.toButtonStyle("Danger"), emoji: "üõë", label: "D·ª´ng ph√°t", disabled: true },
      { customId: "Skip", style: cls.toButtonStyle("Primary"), emoji: "‚è≠", label: "B·ªè qua", disabled: true },
      { customId: "Shuffle", style: cls.toButtonStyle("Primary"), emoji: "üîÄ", label: "X√°o tr·ªôn", disabled: true },
      { customId: "Pause", style: cls.toButtonStyle("Secondary"), emoji: "‚è∏", label: "T·∫°m d·ª´ng", disabled: true },
      { customId: "Autoplay", style: cls.toButtonStyle("Success"), emoji: "üõû", label: "T·ª± ƒë·ªông ph√°t", disabled: true },
    ],
  };
  const button2 = {
    type: "ButtonBuilder",
    options: [
      { customId: "Song", style: cls.toButtonStyle("Success"), emoji: "üîÅ", label: "B√†i h√°t", disabled: true },
      { customId: "Queue", style: cls.toButtonStyle("Success"), emoji: "üîÇ", label: "H√†ng ƒë·ª£i", disabled: true },
      { customId: "Forward", style: cls.toButtonStyle("Primary"), emoji: "‚è©", label: "+10 Gi√¢y", disabled: true },
      { customId: "Rewind", style: cls.toButtonStyle("Primary"), emoji: "‚è™", label: "-10 Gi√¢y", disabled: true },
      { customId: "VolumeUp", style: cls.toButtonStyle("Primary"), emoji: "üîä", label: "+10", disabled: true },
    ],
  };
  const button3 = {
    type: "ButtonBuilder",
    options: [
      { customId: "VolumeDown", style: cls.toButtonStyle("Primary"), emoji: "üîâ", label: "-10", disabled: true },
      { customId: "Lyrics", style: cls.toButtonStyle("Primary"), emoji: "üìù", label: "L·ªùi nh·∫°c", disabled: true },
    ],
  };
  const components = addComponents(menuOptions, button1, button2, button3);
  if (!leave && newQueue && newQueue.songs[0]) {
    // hi·ªÉn th·ªã v√† kh·ªüi ch·∫°y b√†i h√°t ƒë·∫ßu ti√™n
    embeds[1] = new EmbedBuilders({
      images: `https://img.youtube.com/vi/${newQueue.songs[0].id}/mqdefault.jpg`,
      author: { name: `${newQueue.songs[0].name}`, iconURL: `https://images-ext-1.discordapp.net/external/DkPCBVBHBDJC8xHHCF2G7-rJXnTwj_qs78udThL8Cy0/%3Fv%3D1/https/cdn.discordapp.com/emojis/859459305152708630.gif`, url: newQueue.songs[0].url },
      footer: { text: `${newQueue.songs[0].member ? newQueue.songs[0].member?.displayName : "BlackCat-Club"}`, iconURL: newQueue.songs[0].user?.displayAvatarURL({ dynamic: true }) },
      colors: "Random",
      fields: [
        { name: `üîä √Çm l∆∞·ª£ng:`, value: `>>> \`${newQueue.volume} %\``, inline: true },
        { name: `${newQueue.playing ? `‚ôæ V√≤ng l·∫∑p:` : `‚è∏Ô∏è ƒê√£ t·∫°m d·ª´ng:`}`, value: newQueue.playing ? `>>> ${newQueue.repeatMode ? newQueue.repeatMode === 2 ? `‚úîÔ∏è H√†ng ƒë·ª£i` : `‚úîÔ∏è \`B√†i h√°t\`` : `‚ùå`}` : `>>> ‚úîÔ∏è`, inline: true },
        { name: `Autoplay:`, value: `>>> \`ƒêang ${newQueue.autoplay ? "b·∫≠t":"t·∫Øt"}\``, inline: true },
        { name: `‚ùî Filters:`, value: `>>> ${newQueue.filters.names.join(", ") || "‚ùå"}`, inline: true },
        { name: `‚è± Th·ªùi gian:`, value: `\`${newQueue.formattedCurrentTime}\` ${createBar(newQueue.songs[0].duration, newQueue.currentTime, 13)} \`${newQueue.songs[0].formattedDuration}\``, inline: true },
        { name: `üö® Y√™u c·∫ßu b·ªüi:`, value: `>>> ${newQueue.songs[0].member?.displayName}`, inline: true }
      ],
    });
    var maxTracks = 10; // b√†i h√°t / Trang h√†ng ƒë·ª£i 
    embeds[0] = new EmbedBuilders({
      title: { name: `üìÉ h√†ng ƒë·ª£i c·ªßa __${guild.name}__ - [${newQueue.songs.length} b√†i h√°t]` },
      colors: "Random",
      description: `${String(newQueue.songs.slice(0, maxTracks).map((track, index) => `**\` ${++index}. \` ${track.url ? `[${track.name.substr(0, 60).replace(/\[/igu, `\[`).replace(/\]/igu, `\]`)}](${track.url})` : track.name}** - \`${track.isStream ? "Tr·ª±c Ti·∫øp" : track.formattedDuration}\`\n> *ƒê∆∞·ª£c y√™u c·∫ßu b·ªüi: __${track.user ? track.user.globalName : client.user.username}__*`).join(`\n`)).substr(0, 2048)}`,
    });
    // hi·ªÉn th·ªã s·ªë l∆∞·ª£ng b√†i h√°t ƒëang ch·ªù
    if (newQueue.songs.length > 10) {
      embeds[0].addFields({ name: `**\` =>. \` v√† *${newQueue.songs.length > maxTracks ? newQueue.songs.length - maxTracks : newQueue.songs.length}*** b√†i h√°t kh√°c ...`, value: `\u200b` })
    };
    // hi·ªÉn th·ªã b√†i h√°t ƒëang ƒë∆∞·ª£c ph√°t
    embeds[0].addFields({ name: `**\` =>. \` __HI·ªÜN T·∫†I ƒêANG PH√ÅT__**`, value: `**${newQueue.songs[0].url ? `[${newQueue.songs[0].name.substr(0, 60).replace(/\[/igu, `\[`).replace(/\]/igu, `\]`)}](${newQueue.songs[0].url})` : newQueue.songs[0].name}** - \`${newQueue.songs[0].isStream ? "Tr·ª±c Ti·∫øp" : newQueue.formattedCurrentTime}\`\n> *ƒê∆∞·ª£c y√™u c·∫ßu b·ªüi: __${newQueue.songs[0].user ? newQueue.songs[0].user.globalName : client.user.username}__*` })
    // lo·∫°i b·ªè disabled
    components[1].components[0].setDisabled(false);
    components[1].components[1].setDisabled(false);
    components[1].components[2].setDisabled(false);
    components[1].components[3].setDisabled(false);
    components[1].components[4].setDisabled(false);
    components[2].components[0].setDisabled(false);
    components[2].components[1].setDisabled(false);
    components[2].components[2].setDisabled(false);
    components[2].components[3].setDisabled(false);
    components[2].components[4].setDisabled(false);
    components[3].components[0].setDisabled(false);
    components[3].components[1].setDisabled(false);
    if (newQueue.autoplay) {
      components[1].components[4].setStyle(cls.toButtonStyle("Secondary"));
    } else if (newQueue.paused) {
      components[1].components[3].setStyle(cls.toButtonStyle("Success")).setEmoji('‚ñ∂Ô∏è').setLabel("Ti·∫øp t·ª•c");
    };
    if (newQueue.repeatMode === 1) {
      components[2].components[0].setStyle(cls.toButtonStyle("Secondary"));
      components[2].components[1].setStyle(cls.toButtonStyle("Success"));
    } else if (newQueue.repeatMode === 2) {
      components[2].components[0].setStyle(cls.toButtonStyle("Success"));
      components[2].components[1].setStyle(cls.toButtonStyle("Secondary"));
    } else {
      components[2].components[0].setStyle(cls.toButtonStyle("Success"));
      components[2].components[1].setStyle(cls.toButtonStyle("Success"));
    };
  };
  //b√¢y gi·ªù ch√∫ng t√¥i th√™m c√°c th√†nh ph·∫ßn!
  return { embeds, components: components };
};
// c·∫≠p nh·∫≠t H·ªá th·ªëng √¢m nh·∫°c
export const updateMusicSystem = async (client, queue, leave = false) => {
  const data = await musicDB.get(queue.id); // l·∫•y d∆∞c li·ªáu t·ª´ mongodb
  if (!data) return; // n·∫øu kh√¥ng th·∫•y data, return;
  if (!queue) return; // n·∫øu kh√¥ng th·∫•y queue, return;
  if (data.ChannelId && data.ChannelId.length > 5) {
    let guild = client.guilds.cache.get(queue.id);
    if (!guild) return console.log(colors.cyan(`Update-Music-System`) + ` - Music System - Kh√¥ng t√¨m th·∫•y Guild!`) // n·∫øu kh√¥ng t√¨m th·∫•y guilds
    let channel = guild.channels.cache.get(data.ChannelId);
    if (!channel) channel = await guild.channels.fetch(data.ChannelId).catch(() => { }) || false; // t√¨m ki·∫øm channelId...
    if (!channel) return console.log(colors.cyan(`Update-Music-System`) + ` - Music System - Kh√¥ng t√¨m th·∫•y k√™nh!`) // n·∫øu kh√¥ng th·∫•y channelID 
    let message = channel.messages.cache.get(data.MessageId); // l·∫•y messageID 
    if (!message) message = await channel.messages.fetch(data.MessageId).catch(() => { }) || false; // n·∫øu kh√¥ng t√¨m th·∫•y messageID th√¨ tr·∫£ v·ªÅ false
    if (!message) return console.log(colors.cyan(`Update-Music-System`) + ` - Music System - Kh√¥ng t√¨m th·∫•y tin nh·∫Øn!`)
    message.edit(generateQueueEmbed(client, queue.id, leave)).catch((e) => {
      console.log(e);
    }).then(() => console.log(colors.hex('#FFA500')(`- ƒê√£ ch·ªânh s·ª≠a tin nh·∫Øn do T∆∞∆°ng t√°c c·ªßa ng∆∞·ªùi d√πng`)));
  };
};
// export module. ƒë√¢y s·∫Ω l√† modules ch√≠nh m√† bot ch·∫°y
export default function DistubeHandlers(client) {
  const distube = client.distube; // x√°c ƒë·ªãnh evnets c·ªßa distube cung c·∫•p
  // t·ª± ƒë·ªông ph√°t nh·∫°c khi bot b·ªã m·∫•t k·∫øt n·ªëi
  client.on("ready", () => {
    setTimeout(async () => {
      let guilds = await autoresume.keysAll();
      console.log(colors.cyanBright("Autoresume: -T·ª± ƒë·ªông ti·∫øp t·ª•c c√°c b√†i h√°t:"), guilds);
      if (!guilds || guilds.length == 0) return;
      for (const gId of guilds) {
        try {
          let guild = client.guilds.cache.get(gId);
          let data = await autoresume.get(gId);
          if (!guild) {
            await autoresume.remove(gId);
            console.log(colors.redBright(`Autoresume: - Bot b·ªã kick ra kh·ªèi Guild`));
            continue;
          };
          let voiceChannel = guild.channels.cache.get(data.voiceChannel);
          if (!voiceChannel && data.voiceChannel) voiceChannel = (await guild.channels.fetch(data.voiceChannel).catch(() => { })) || false;
          if (!voiceChannel || !voiceChannel.members || voiceChannel.members.filter((m) => !m.user.bot && !m.voice.deaf && !m.voice.selfDeaf).size < 1) {
            await autoresume.remove(gId);
            console.log(colors.cyanBright("Autoresume: - K√™nh voice tr·ªëng / Kh√¥ng c√≥ ng∆∞·ªùi nghe / ƒë√£ b·ªã xo√°"));
            continue;
          };
          let textChannel = guild.channels.cache.get(data.textChannel);
          if (!textChannel) textChannel = await guild.channels.fetch(data.textChannel).catch(() => { }) || false;
          if (!textChannel) {
            await autoresume.remove(gId);
            console.log(colors.cyanBright(`Autoresume: - K√™nh vƒÉn b·∫£n ƒë√£ b·ªã x√≥a`));
            continue;
          };
          let tracks = data.songs;
          if (!tracks || !tracks[0]) {
            console.log(colors.cyanBright(`Autoresume: - ƒê√£ h·ªßy tr√¨nh ph√°t, v√¨ kh√¥ng c√≥ b·∫£n nh·∫°c n√†o`));
            continue;
          };
          await client.distube.play(voiceChannel, tracks[0].url, {
            member: guild.members.cache.get(tracks[0].memberId) || guild.me,
            textChannel: textChannel
          });
          let newQueue = client.distube.getQueue(guild.id);
          // t·∫°o 1 v√≤ng l·∫∑p theo d√µi
          for (const track of tracks.slice(1)) {
            newQueue.songs.push(() => {
              return new Song(new SearchResultVideo({
                duration: track.duration,
                formattedDuration: track.formattedDuration,
                id: track.id,
                isLive: track.isLive,
                name: track.name,
                thumbnail: track.thumbnail,
                type: "video",
                uploader: track.uploader,
                url: track.url,
                views: track.views,
              }), guild.members.cache.get(track.memberId) || guild.members.me, track.source);
            });
          };
          console.log(colors.cyanBright(`Autoresume:  - ƒê√£ th√™m ${newQueue.songs.length} v√†i h√°t v√†o h√†nh ƒë·ª£i v√† b·∫Øt ƒë·∫ßu ph√°t ${newQueue.songs[0].name} trong ${guild.name}`));
          // ƒêI·ªÄU CH·ªàNH C√ÄI ƒê·∫∂T H√ÄNG ƒê·ª¢I
          // thi·∫øt l·∫≠p m·ª©c √¢m l∆∞·ª£ng
          await newQueue.setVolume(data.volume);
          // ƒë·∫∑t Ch·∫ø ƒë·ªô l·∫∑p l·∫°i
          if (data.repeatMode && data.repeatMode !== 0) {
            newQueue.setRepeatMode(data.repeatMode);
          };
          // ti·∫øp t·ª•c ph√°t ·ªü ph√¢n ƒëo·∫°n tr∆∞·ªõc ƒë√≥
          await newQueue.seek(data.currentTime);
          // th√™m b·ªô l·ªçc cho b√†i h√°t
          if (data.filters && data.filters.length > 0) {
            await newQueue.filters.set(data.filters, true);
          };
          // th√™m autoplay n·∫øu bot ƒëang ƒë∆∞·ª£c b·∫≠t
          if(data.autoplay === Boolean(true)) {
            newQueue.autoplay = Boolean(data.autoplay);
          };
          // xo√° b√†i h√°t
          await autoresume.remove(newQueue.id);
          console.log(colors.cyanBright(`Autoresume: - ƒê√£ thay ƒë·ªïi theo d√µi autoresume ƒë·ªÉ ƒëi·ªÅu ch·ªânh h√†ng ƒë·ª£i + ƒë√£ x√≥a m·ª•c nh·∫≠p c∆° s·ªü d·ªØ li·ªáu `));
          await new Promise((resolve) => {
            setTimeout(() => resolve(2), 1000);
          });
        } catch (e) {
          console.log(e);
        };
      };
    }, 2 * client.ws.ping);
  });
  /*========================================================
  # B·∫Øt ƒë·∫ßu ch·∫°y c√°c evnets
  ========================================================*/
  distube.on("playSong", async (queue, track) => {
    const data = await musicDB.get(queue.id);
    if (!data) return; // t√¨m ki·∫øm data trong database // n·∫øu kh√¥ng th·∫•y data. return;
    var newQueue = distube.getQueue(queue.id);
    updateMusicSystem(client, newQueue);
    const nowplay = await queue.textChannel?.send(receiveQueueData(newQueue, track)).then(async (message) => {
      PlayerMap.set("idTextchannel", message.id);
      return message;
    }).catch((e) => console.log(e));
    if (queue.textChannel?.id === data.ChannelId) return;
    var collector = nowplay?.createMessageComponentCollector({
      filter: (i) => i.isButton() && i.user && i.message.author.id == client.user.id,
      time: track.duration > 0 ? track.duration * 1000 : 600000,
    });
    try { clearInterval(songEditInterval) } catch (e) { };
    songEditInterval = setInterval(async () => {
      if (!lastEdited) {
        try {
          var newQueue = distube.getQueue(queue.id);
          return await nowplay.edit(receiveQueueData(newQueue, newQueue.songs[0])).catch((e) => { });
        } catch (e) {
          clearInterval(songEditInterval);
        };
      };
    }, 4000);
    collector?.on('collect', async (i) => {
      lastEdited = true;
      setTimeout(() => lastEdited = false, 7000);
      let member = i.member;
      // if(!member.voice.channel) return i.reply({ content: "‚ùå **B·∫°n ph·∫£i tham gia k√™nh voice m·ªõi c√≥ th·ªÉ s·ª≠ d·ª•ng l·ªánh**" });
      const test = i.guild.channels.cache.filter(chnl => (chnl.type == ChannelType.GuildVoice)).find(channel => (channel.members.has(client.user.id)));
      if (test && member.voice.channel?.id !== test?.id) return interaction.reply({ embeds: [new EmbedBuilder().setDescription(`‚ùå T√¥i ƒë√£ ch∆°i trong <#${test?.id}>`)], ephemeral: true });
      // b·ªè qua b√†i h√°t
      if (i.customId == `skip`) {
        if (!member.voice.channel) return i.reply({ content: `**B·∫°n ph·∫£i tham gia k√™nh voice m·ªõi c√≥ th·ªÉ s·ª≠ d·ª•ng l·ªánh**` });
        if (!distube.getQueue(i.guild.id) || !newQueue.songs || newQueue.songs.length == 0) return await i.reply({ content: "Danh s√°ch nh·∫°c tr·ªëng" });
        if (member.voice.channel.id !== newQueue.voiceChannel.id) return i.reply({ content: `**Tham gia k√™nh voice c·ªßa t√¥i**` });
        if (newQueue.songs.length == 0) {
          clearInterval(songEditInterval);
          await distube.stop(i.guild.id);
          return await i.reply({
            embeds: [new EmbedBuilders({
              colors: "Random",
              title: { name: "‚èπ **D·ª´ng ph√°t nh·∫°c**" },
              footer: { text: `Y√™u c·∫ßu b·ªüi: ${member.user.tag}`, iconURL: `${member.user.displayAvatarURL({ dynamic: true })}` },
            })]
          }).then((i) => {
            setTimeout(() => i.interaction.deleteReply(), 3000);
          }).catch((e) => { });
        };
        try {
          await distube.skip(i.guild.id)
          await i.reply({
            embeds: [new EmbedBuilder()
              .setColor("Random").setTimestamp()
              .setTitle(`‚è≠ **B·ªè qua b√†i h√°t!**`)
              .setFooter({ text: `Yesu c·∫ßu b·ªüi: ${member.user.tag}`, iconURL: `${member.user.displayAvatarURL({ dynamic: true })}` })
            ]
          }).then((i) => {
            setTimeout(() => i.interaction.deleteReply(), 3000);
          }).catch((e) => { });
          nowplay.edit({ components: [] });
        } catch (error) {
          i.reply({ content: "Hi·ªán t·∫°i ch·ªâ c√≥ m·ªôt b√†i h√°t trong playlist, b·∫°n c·∫ßn th√™m t·ªëi thi·ªÉu √≠t nh·∫•t m·ªôt b√†i h√°t n·ªØa ..." }).then((i) => {
            setTimeout(() => i.interaction.deleteReply(), 3000);
          }).catch((e) => { });
        };
      } else if (i.customId == "stop") {
        if (!member.voice.channel) return i.reply({ content: `**B·∫°n ph·∫£i tham gia k√™nh voice m·ªõi c√≥ th·ªÉ s·ª≠ d·ª•ng l·ªánh**` });
        if (!distube.getQueue(i.guild.id) || !newQueue.songs || newQueue.songs.length == 0) return await i.reply({ content: "Danh s√°ch nh·∫°c tr·ªëng" });
        if (member.voice.channel.id !== newQueue.voiceChannel.id) return i.reply({ content: `**Tham gia k√™nh voice c·ªßa t√¥i**` });
        nowplay.edit({ components: [] });
        await i.reply({ content: "üëå ƒê√£ d·ª´ng ph√°t nh·∫°c v√† r·ªùi kh·ªèi k√™nh voice channel theo y√™u c·∫ßu" }).then((i) => {
          setTimeout(() => i.interaction.deleteReply(), 3000);
        }).catch((e) => { });
        await distube.voices.leave(i.guild.id);
      } else if (i.customId == "pause") {
        if (!member.voice.channel) return i.reply({ content: `**B·∫°n ph·∫£i tham gia k√™nh voice m·ªõi c√≥ th·ªÉ s·ª≠ d·ª•ng l·ªánh**` });
        if (!distube.getQueue(i.guild.id) || !newQueue.songs || newQueue.songs.length == 0) return await i.reply({ content: "Danh s√°ch nh·∫°c tr·ªëng" });
        if (member.voice.channel.id !== newQueue.voiceChannel.id) return i.reply({ content: `**Tham gia k√™nh voice c·ªßa t√¥i**` });
        if (newQueue.playing) {
          await distube.pause(i.guild.id);
          nowplay.edit(receiveQueueData(distube.getQueue(newQueue.id), newQueue.songs[0])).catch((e) => { })
          await i.reply({
            embeds: [new EmbedBuilder()
              .setColor("Random").setTimestamp()
              .setTitle(`‚è∏ **T·∫°m d·ª´ng**`)
              .setFooter({ text: `y√™u c·∫ßu b·ªüi ${member.user.tag}`, iconURL: `${member.user.displayAvatarURL({ dynamic: true })}` })]
          }).then((i) => {
            setTimeout(() => i.interaction.deleteReply(), 3000);
          }).catch((e) => { });
        } else {
          await distube.resume(i.guild.id);
          nowplay.edit(receiveQueueData(distube.getQueue(newQueue.id), newQueue.songs[0])).catch((e) => { })
          await i.reply({
            embeds: [new EmbedBuilder()
              .setColor("Random").setTimestamp()
              .setTitle(`‚ñ∂Ô∏è **ti·∫øp t·ª•c**`)
              .setFooter({ text: `Y√™u c·∫ßu b·ªüi ${member.user.tag}`, iconURL: `${member.user.displayAvatarURL({ dynamic: true })}` })]
          }).then((i) => {
            setTimeout(() => i.interaction.deleteReply(), 3000);
          }).catch((e) => { });
        };
      } else if (i.customId == "autoplay") {
        if (!member.voice.channel) return i.reply({ content: `**B·∫°n ph·∫£i tham gia k√™nh voice m·ªõi c√≥ th·ªÉ s·ª≠ d·ª•ng l·ªánh**` });
        if (!distube.getQueue(i.guild.id) || !newQueue.songs || newQueue.songs.length == 0) return await i.reply({ content: "Danh s√°ch nh·∫°c tr·ªëng" });
        if (member.voice.channel.id !== newQueue.voiceChannel.id) return i.reply({ content: `**Tham gia k√™nh voice c·ªßa t√¥i**` });
        await newQueue.toggleAutoplay()
        if (newQueue.autoplay) {
          nowplay.edit(receiveQueueData(distube.getQueue(newQueue.id), newQueue.songs[0])).catch((e) => { });
        } else {
          nowplay.edit(receiveQueueData(distube.getQueue(newQueue.id), newQueue.songs[0])).catch((e) => { });
        };
        await i.reply({
          embeds: [new EmbedBuilder()
            .setColor("Random").setTimestamp()
            .setTitle(`${newQueue.autoplay ? `‚úîÔ∏è **ƒê√£ b·∫≠t ch·∫ø ƒë·ªô t·ª± ƒë·ªông ph√°t**` : `‚ùå **ƒê√£ t·∫Øt ch·∫ø ƒë·ªô t·ª± ƒë·ªông ph√°t**`}`)
            .setFooter({ text: `y√™u c·∫ßu b·ªüi ${member.user.tag}`, iconURL: `${member.user.displayAvatarURL({ dynamic: true })}` })]
        }).then((i) => {
          setTimeout(() => i.interaction.deleteReply(), 3000);
        }).catch((e) => { });
      } else if (i.customId == "shuffle") {
        if (!member.voice.channel) return i.reply({ content: `**B·∫°n ph·∫£i tham gia k√™nh voice m·ªõi c√≥ th·ªÉ s·ª≠ d·ª•ng l·ªánh**` });
        if (!distube.getQueue(i.guild.id) || !newQueue.songs || newQueue.songs.length == 0) return await i.reply({ content: "Danh s√°ch nh·∫°c tr·ªëng" });
        if (member.voice.channel.id !== newQueue.voiceChannel.id) return i.reply({ content: `**Tham gia k√™nh voice c·ªßa t√¥i**` });

        client.maps.set(`beforeshuffle-${newQueue.id}`, newQueue.songs.map(track => track).slice(1));
        await newQueue.shuffle()
        await i.reply({
          embeds: [new EmbedBuilder()
            .setColor("Random").setTimestamp()
            .setTitle(`üîÄ **X√°o tr·ªôn ${newQueue.songs.length} b√†i h√°t!**`)
            .setFooter({ text: `YC b∆°Ãâi: ${member.user.tag}`, iconURL: `${member.user.displayAvatarURL({ dynamic: true })}` })]
        }).then((i) => {
          setTimeout(() => i.interaction.deleteReply(), 3000);
        }).catch((e) => { });
      } else if (i.customId == "song") {
        if (!member.voice.channel) return i.reply({ content: `**B·∫°n ph·∫£i tham gia k√™nh voice m·ªõi c√≥ th·ªÉ s·ª≠ d·ª•ng l·ªánh**` });
        if (!distube.getQueue(i.guild.id) || !newQueue.songs || newQueue.songs.length == 0) return await i.reply({ content: "Danh s√°ch nh·∫°c tr·ªëng" });
        if (member.voice.channel.id !== newQueue.voiceChannel.id) return i.reply({ content: `**Tham gia k√™nh voice c·ªßa t√¥i**` });

        if (newQueue.repeatMode == 1) {
          await newQueue.setRepeatMode(0);
        } else {
          await newQueue.setRepeatMode(1);
        };
        await i.reply({
          embeds: [new EmbedBuilder()
            .setColor("Random").setTimestamp()
            .setTitle(`${newQueue.repeatMode == 1 ? `‚úîÔ∏è **L·∫∑p b√†i h√°t ƒë√£ b·∫≠t**` : `‚ùå **L·∫∑p b√†i h√°t ƒë√£ t·∫Øt**`}`)
            .setFooter({ text: `Y√™u c·∫ßu b·ªüi: ${member.user.tag}`, iconURL: `${member.user.displayAvatarURL({ dynamic: true })}` })]
        }).then((i) => setTimeout(() => i.interaction.deleteReply(), 3000)).catch((e) => { });
        nowplay.edit(receiveQueueData(distube.getQueue(newQueue.id), newQueue.songs[0])).catch((e) => { });
      } else if (i.customId == "queue") {
        if (!member.voice.channel) return i.reply({ content: `**B·∫°n ph·∫£i tham gia k√™nh voice m·ªõi c√≥ th·ªÉ s·ª≠ d·ª•ng l·ªánh**` });
        if (!distube.getQueue(i.guild.id) || !newQueue.songs || newQueue.songs.length == 0) return await i.reply({ content: "Danh s√°ch nh·∫°c tr·ªëng" });
        if (member.voice.channel.id !== newQueue.voiceChannel.id) return i.reply({ content: `**Tham gia k√™nh voice c·ªßa t√¥i**` });
        if (newQueue.repeatMode == 2) {
          await newQueue.setRepeatMode(0);
        } else {
          await newQueue.setRepeatMode(2);
        };
        await i.reply({
          embeds: [new EmbedBuilder()
            .setColor("Random").setTimestamp()
            .setTitle(`${newQueue.repeatMode == 2 ? `**L·∫∑p h√†ng ƒë·ª£i ƒë√£ b·∫≠t**` : `**L·∫∑p h√†ng ƒë·ª£i ƒë√£ t·∫Øt**`}`)
            .setFooter({ text: `Y√™u c·∫ßu b·ªüi: ${member.user.tag}`, iconURL: `${member.user.displayAvatarURL({ dynamic: true })}` })]
        }).then((i) => setTimeout(() => i.interaction.deleteReply(), 3000)).catch((e) => { });
        nowplay.edit(receiveQueueData(distube.getQueue(newQueue.id), newQueue.songs[0])).catch((e) => { });
      } else if (i.customId == "seek") {
        if (!member.voice.channel) return i.reply({ content: `**B·∫°n ph·∫£i tham gia k√™nh voice m·ªõi c√≥ th·ªÉ s·ª≠ d·ª•ng l·ªánh**` });
        if (!distube.getQueue(i.guild.id) || !newQueue.songs || newQueue.songs.length == 0) return await i.reply({ content: "Danh s√°ch nh·∫°c tr·ªëng" });
        if (member.voice.channel.id !== newQueue.voiceChannel.id) return i.reply({ content: `**Tham gia k√™nh voice c·ªßa t√¥i**` });
        let seektime = newQueue.currentTime + 10;
        if (seektime >= newQueue.songs[0].duration) seektime = newQueue.songs[0].duration - 1;
        await newQueue.seek(Number(seektime))
        collector.resetTimer({ time: (newQueue.songs[0].duration - newQueue.currentTime) * 1000 })
        await i.reply({
          embeds: [new EmbedBuilder()
            .setColor("Random").setTimestamp()
            .setTitle(`‚è© **+10 Gi√¢y!**`)
            .setFooter({ text: `y√™u c·∫ßu b·ªüi: ${member.user.tag}`, iconURL: `${member.user.displayAvatarURL({ dynamic: true })}` })]
        }).then((i) => setTimeout(() => i.interaction.deleteReply(), 3000)).catch((e) => { });
        nowplay.edit(receiveQueueData(distube.getQueue(newQueue.id), newQueue.songs[0])).catch((e) => { })
      } else if (i.customId == "seek2") {
        if (!member.voice.channel) return i.reply({ content: `**B·∫°n ph·∫£i tham gia k√™nh voice m·ªõi c√≥ th·ªÉ s·ª≠ d·ª•ng l·ªánh**` });
        if (!distube.getQueue(i.guild.id) || !newQueue.songs || newQueue.songs.length == 0) return await i.reply({ content: "Danh s√°ch nh·∫°c tr·ªëng" });
        if (member.voice.channel.id !== newQueue.voiceChannel.id) return i.reply({ content: `**Tham gia k√™nh voice c·ªßa t√¥i**` });
        let seektime = newQueue.currentTime - 10;
        if (seektime < 0) seektime = 0;
        if (seektime >= newQueue.songs[0].duration - newQueue.currentTime) seektime = 0;
        await newQueue.seek(Number(seektime))
        collector.resetTimer({ time: (newQueue.songs[0].duration - newQueue.currentTime) * 1000 })
        await i.reply({
          embeds: [new EmbedBuilder()
            .setColor("Random").setTimestamp()
            .setTitle(`‚è™ **-10 Gi√¢y!**`)
            .setFooter({ text: `y√™u c·∫ßu b·ªüi: ${member.user.tag}`, iconURL: `${member.user.displayAvatarURL({ dynamic: true })}` })]
        }).then((i) => setTimeout(() => i.interaction.deleteReply(), 3000)).catch((e) => { });
        nowplay.edit(receiveQueueData(distube.getQueue(newQueue.id), newQueue.songs[0])).catch((e) => { })
      } else if (i.customId == `lyrics`) {
        if (!member.voice.channel) return i.reply({ content: `**B·∫°n ph·∫£i tham gia k√™nh voice m·ªõi c√≥ th·ªÉ s·ª≠ d·ª•ng l·ªánh**` });
        if (!distube.getQueue(i.guild.id) || !newQueue.songs || newQueue.songs.length == 0) return await i.reply({ content: "Danh s√°ch nh·∫°c tr·ªëng" });
        if (member.voice.channel.id !== newQueue.voiceChannel.id) return i.reply({ content: `**Tham gia k√™nh voice c·ªßa t√¥i**` });
        await i.deferReply();
        try {
          let thumbnail = newQueue.songs.map((song) => song.thumbnail).slice(0, 1).join("\n");
          let name = newQueue.songs.map((song) => song.name).slice(0, 1).join("\n");
          const findLyrics = lyricsFinder(name);
          var lyrics
          findLyrics.then((ly) => {
            return lyrics = ly;
          });
          i.editReply({
            embeds: [new EmbedBuilder()
              .setAuthor({ name: name, iconURL: thumbnail, url: newQueue.songs.map((song) => song.url).slice(0, 1).join("\n") })
              .setColor("Random")
              .setThumbnail(thumbnail)
              .setDescription(lyrics ? lyrics : "Kh√¥ng t√¨m th·∫•y l·ªùi b√†i h√°t!")
            ], ephemeral: true
          });
        } catch (e) {
          console.log(e)
          i.editReply({ content: "ƒê√£ s·∫£y ra l·ªói vui l√≤ng th·ª≠ l·∫°i sau", ephemeral: true });
        };
      } else if (i.customId == "volumeUp") {
        if (!member.voice.channel) return i.reply({ content: `**B·∫°n ph·∫£i tham gia k√™nh voice m·ªõi c√≥ th·ªÉ s·ª≠ d·ª•ng l·ªánh**` });
        if (!distube.getQueue(i.guild.id) || !newQueue.songs || newQueue.songs.length == 0) return await i.reply({ content: "Danh s√°ch nh·∫°c tr·ªëng" });
        if (member.voice.channel.id !== newQueue.voiceChannel.id) return i.reply({ content: `**Tham gia k√™nh voice c·ªßa t√¥i**` });
        try {
          const volumeUp = Number(newQueue.volume) + 10;
          if (volumeUp < 0 || volumeUp > 100) return i.reply({
            embeds: [new EmbedBuilder().setColor("Random").setDescription("B·∫°n ch·ªâ c√≥ th·ªÉ ƒë·∫∑t √¢m l∆∞·ª£ng t·ª´ 0 ƒë·∫øn 100.").setTimestamp()], ephemeral: true
          });
          await newQueue.setVolume(volumeUp);
          await i.reply({ content: `:white_check_mark: | √Çm l∆∞·ª£ng tƒÉng l√™n ${volumeUp}%` }).then((i) => {
            setTimeout(() => i.interaction.deleteReply(), 3000);
          });
        } catch (error) {
          console.log(error);
        };
      } else if (i.customId == "volumeDown") {
        if (!member.voice.channel) return i.reply({ content: `**B·∫°n ph·∫£i tham gia k√™nh voice m·ªõi c√≥ th·ªÉ s·ª≠ d·ª•ng l·ªánh**` });
        if (!distube.getQueue(i.guild.id) || !newQueue.songs || newQueue.songs.length == 0) return await i.reply({ content: "Danh s√°ch nh·∫°c tr·ªëng" });
        if (member.voice.channel.id !== newQueue.voiceChannel.id) return i.reply({ content: `**Tham gia k√™nh voice c·ªßa t√¥i**` });
        try {
          const volumeDown = Number(newQueue.volume) - 10;
          const invalidVolume = new EmbedBuilder().setColor("Random").setDescription(":x: | Kh√¥ng th·ªÉ gi·∫£m √¢m l∆∞·ª£ng c·ªßa b·∫°n n·ªØa n·∫øu ti·∫øp t·ª•c gi·∫£m b·∫°n s·∫Ω kh√¥ng nghe th·∫•y g√¨").setTimestamp();
          if (volumeDown <= 0) return i.reply({ embeds: [invalidVolume], ephemeral: true });
          await newQueue.setVolume(volumeDown);
          await i.reply({ content: `:white_check_mark: | √Çm l∆∞·ª£ng gi·∫£m xu·ªëng ${volumeDown}%` }).then((i) => {
            setTimeout(() => i.interaction.deleteReply(), 3000);
          });
        } catch (error) {
          console.log(error);
        };
      };
    });
    collector?.on('end', async (collected, reason) => {
      if (reason === "time") {
        nowplay.edit({ components: [] });
      };
    });
  });
  distube.on("finish", async (queue) => {
    return queue.textChannel?.send({
      embeds: [new EmbedBuilders({ color: "Random", description: "ƒê√£ ph√°t h·∫øt nh·∫°c trong h√†ng ƒë·ª£i... r·ªùi kh·ªèi k√™nh voice" })]
    }).catch((e) => { });
  });
  distube.on("addList", async (queue, playlist) => {
    const embed = new EmbedBuilders({
      description: `üëç Danh saÃÅch: [\`${playlist.name}\`](${playlist.url ? playlist.url : ``})  -  \`${playlist.songs.length} B√†i h√°t ${playlist.songs.length > 0 ? `` : ``}\``,
      thumbnail: `${playlist.thumbnail.url ? playlist.thumbnail.url : `https://img.youtube.com/vi/${playlist.songs[0].id}/mqdefault.jpg`}`,
      footer: { text: `üíØ ${playlist.user.tag}`, iconURL: `${playlist.user.displayAvatarURL({ dynamic: true })}` },
      title: { name: "ƒê√£ th√™m v√†i h√°t v√†o h√†ng ƒë·ª£i" },
      timestamp: Date.now(),
      colors: "Random",
      fields: [
        { name: `**Th·ªùi gian d·ª± t√≠nh**`, value: `\`${queue.songs.length - - playlist.songs.length} B√†i h√°t\` - \`${(Math.floor((queue.duration - playlist.duration) / 60 * 100) / 100).toString().replace(`.`, `:`)}\``, inline: true },
        { name: `**Th·ªùi l∆∞·ª£ng h√†ng ƒë·ª£i**`, value: `\`${queue.formattedDuration}\``, inline: true },
      ]
    });
    return queue.textChannel?.send({ embeds: [embed] }).catch((e) => { });
  });
  distube.on("addSong", async (queue, song) => {
    const embed = new EmbedBuilders({
      author: { name: `B√†i h√°t ƒë√£ ƒë∆∞·ª£c th√™m!`, iconURL: `${song.user.displayAvatarURL({ dynamic: true })}`, url: `${song.url}` },
      footer: { text: `üíØ ${song.user.tag}`, iconURL: `${song.user.displayAvatarURL({ dynamic: true })}` },
      description: `üëç B√†i h√°t: [${song.name}](${song.url})  -  ${song.formattedDuration}`,
      thumbnail: `https://img.youtube.com/vi/${song.id}/mqdefault.jpg`,
      timestamp: Date.now(),
      colors: "Random",
      fields: [
        { name: `‚åõ **Th·ªùi gian d·ª± t√≠nh**`, value: `\`${queue.songs.length - 1} B√†i h√°t\` - \`${(Math.floor((queue.duration - song.duration) / 60 * 100) / 100).toString().replace(`.`, `:`)}\``, inline: true },
        { name: `üé• L∆∞·ª£t xem`, value: `${(queue.songs[0].views).toLocaleString()}`, inline: true },
        { name: `üëç Likes`, value: `${(queue.songs[0].likes).toLocaleString()}`, inline: true },
        { name: `üëé Dislikes`, value: `${(queue.songs[0].dislikes).toLocaleString()}`, inline: true },
        { name: `üåÄ **Th·ªùi l∆∞·ª£ng h√†ng ƒë·ª£i**`, value: `\`${queue.formattedDuration}\``, inline: true },
      ]
    });
    return queue.textChannel?.send({ embeds: [embed] }).catch((e) => { });
  });
  distube.on("deleteQueue", async (queue) => {
    if (!PlayerMap.has(`deleted-${queue.id}`)) {
      PlayerMap.set(`deleted-${queue.id}`, true);
      if (client.maps.has(`beforeshuffle-${queue.id}`)) {
        client.maps.delete(`beforeshuffle-${queue.id}`);
      };
      try {
        //X√≥a kho·∫£ng th·ªùi gian ƒë·ªÉ ki·ªÉm tra h·ªá th·ªëng th√¥ng b√°o li√™n quan
        clearInterval(playerintervals.get(`checkrelevantinterval-${queue.id}`));
        playerintervals.delete(`checkrelevantinterval-${queue.id}`);
        // X√≥a kho·∫£ng th·ªùi gian cho H·ªá th·ªëng Embed Ch·ªânh s·ª≠a Nh·∫°c
        clearInterval(playerintervals.get(`musicsystemeditinterval-${queue.id}`));
        playerintervals.delete(`musicsystemeditinterval-${queue.id}`);
        // X√≥a Kho·∫£ng th·ªùi gian cho tr√¨nh ti·∫øt ki·ªám h·ªì s∆° t·ª± ƒë·ªông
        clearInterval(playerintervals.get(`autoresumeinterval-${queue.id}`))
        if (autoresume.has(queue.id)) await autoresume.remove(queue.id); // X√≥a db n·∫øu n√≥ v·∫´n ·ªü ƒë√≥
        playerintervals.delete(`autoresumeinterval-${queue.id}`);
      } catch (e) {
        console.log(e);
      };
      updateMusicSystem(client, queue, true);
      const embeds = new EmbedBuilders({
        description: `:headphones: **H√†ng ƒë·ª£i ƒë√£ b·ªã x√≥a**`,
        title: { name: "K·∫øt th√∫c b√†i h√°t" },
        timestamp: Date.now(),
        colors: "Random",
      });
      return queue.textChannel?.send({ embeds: [embeds] }).catch((ex) => { });
    };
  });
  distube.on("initQueue", async (queue) => {
    // t√¨m ki·∫øm trong c∆° s·ªü d·ªØ li·ªáu xem c√≥ m·ª•c n√†y hay kh√¥ng 
    const data = await musicDB.get(queue.id);
    var newQueue = distube.getQueue(queue.id);
    if (!data) return; // n·∫øu data tr·ªëng th√¨ return;
    let channelId = data.ChannelId; // get id channel t·ª´ c∆° s·ªü d·ªØ li·ªáu
    let messageId = data.MessageId; // get id message t·ª´ c∆° s·ªü d·ªØ li·ªáu
    if (PlayerMap.has(`deleted-${queue.id}`)) {
      PlayerMap.delete(`deleted-${queue.id}`);
    };
    queue.autoplay = Boolean(data.DefaultAutoplay || false); // m·∫∑c ƒë·ªãnh t·ª± ƒë·ªông ph√°t false
    queue.volume = Number(data.DefaultVolume || 50); // m·∫∑c ƒë·ªãnh √¢m l∆∞·ª£ng l√† 50v
    queue.filters.set(data.DefaultFilters || ['bassboost']); // m·∫∑c ƒë·ªãnh filters l√† bassboost, 3d
    queue.voice.setSelfDeaf(true); // x√©t ch·∫ø ƒë·ªô ƒëi·∫øc cho bot
    /** 
    * Ki·ªÉm tra c√°c th√¥ng b√°o c√≥ li√™n quan b√™n trong K√™nh y√™u c·∫ßu h·ªá th·ªëng √¢m nh·∫°c
    */
    playerintervals.set(`checkrelevantinterval-${queue.id}`, setInterval(async () => {
      if (channelId && channelId.length > 5) {
        console.log(colors.cyanBright(`Music System - Relevant Checker`) + ` - Ki·ªÉm tra c√°c tin nh·∫Øn kh√¥ng li√™n quan`);
        let guild = client.guilds.cache.get(queue.id);
        if (!guild) return console.log(colors.cyanBright(`Music System - Relevant Checker`) + ` - Kh√¥ng t√¨m th·∫•y Guild!`);
        let channel = guild.channels.cache.get(channelId);
        if (!channel) channel = await guild.channels.fetch(channelId).catch(() => { }) || false;
        if (!channel) return console.log(colors.cyanBright(`Music System - Relevant Checker`) + ` - Kh√¥ng t√¨m th·∫•y k√™nh!`);
        let messages = await channel.messages.fetch();
        if (messages.filter((m) => m.id != messageId).size > 0) {
          channel.bulkDelete(messages.filter((m) => m.id != messageId)).catch(() => { }).then(messages => console.log(colors.cyanBright(`Music System - Relevant Checker`) + ` - ƒê√£ x√≥a h√†ng lo·∫°t ${messages.size ? messages.size : "0"} tin nh·∫Øn`));
        } else {
          console.log(colors.cyanBright(`Music System - Relevant Checker`) + ` - Kh√¥ng c√≥ tin nh·∫Øn li√™n quan`);
        };
      };
    }, 60000));
    /**
    * Music System Edit Embeds
    */
    playerintervals.set(`musicsystemeditinterval-${queue.id}`, setInterval(async () => {
      if (channelId && channelId.length > 5) {
        let guild = client.guilds.cache.get(queue.id);
        if (!guild) return console.log(colors.magentaBright("Music System Edit Embeds") + ` - Music System - Kh√¥ng t√¨m th·∫•y Guild!`);
        let channel = guild.channels.cache.get(channelId);
        if (!channel) channel = await guild.channels.fetch(channelId).catch(() => { }) || false;
        if (!channel) return console.log(colors.magentaBright("Music System Edit Embeds") + ` - Music System - Kh√¥ng t√¨m th·∫•y k√™nh!`);
        let message = channel.messages.cache.get(messageId);
        if (!message) message = await channel.messages.fetch(messageId).catch(() => { }) || false;
        if (!message) return console.log(colors.magentaBright("Music System Edit Embeds") + ` - Music System - Kh√¥ng t√¨m th·∫•y tin nh·∫Øn!`);
        if (!message.editedTimestamp) return console.log(colors.magentaBright("Music System Edit Embeds") + ` - Ch∆∞a t·ª´ng ch·ªânh s·ª≠a tr∆∞·ªõc ƒë√¢y!`);
        if (Date.now() - message.editedTimestamp > (7000) - 100) {
          message.edit(generateQueueEmbed(client, queue.id)).catch((e) => console.log(e)).then(() => {
            console.log(colors.magentaBright("Music System Edit Embeds") + ` - ƒê√£ ch·ªânh s·ª≠a embed h·ªá th·ªëng √¢m nh·∫°c, v√¨ kh√¥ng c√≥ ch·ªânh s·ª≠a n√†o kh√°c trong ${Math.floor((7000) / 1000)} gi√¢y!`)
          });
        };
      };
    }, 7000));
    /**
    * AUTO-RESUME-DATABASING
    */
    playerintervals.set(`autoresumeinterval-${queue.id}`, setInterval(async () => {
      if (newQueue && newQueue.id && true) {
        return await autoresume.set(newQueue.id, {
          guild: newQueue.id,
          voiceChannel: newQueue.voiceChannel ? newQueue.voiceChannel.id : null,
          textChannel: newQueue.textChannel ? newQueue.textChannel.id : null,
          currentTime: newQueue.currentTime,
          repeatMode: newQueue.repeatMode,
          autoplay: newQueue.autoplay,
          playing: newQueue.playing,
          volume: newQueue.volume,
          filters: [...newQueue.filters.names].filter(Boolean),
          songs: newQueue.songs && newQueue.songs.length > 0 ? [...newQueue.songs].map((track) => {
            return {
              memberId: track.memberId,
              source: track.source,
              duration: track.duration,
              formattedDuration: track.formattedDuration,
              id: track.id,
              isLive: track.isLive,
              name: track.name,
              thumbnail: track.thumbnail,
              type: "video",
              uploader: track.uploader,
              url: track.url,
              views: track.views,
            };
          }) : null,
        });
      };
    }, 5000));
  });
  distube.on("noRelated", async (queue) => {
    return await queue.textChannel?.send({ content: "Kh√¥ng th·ªÉ t√¨m th·∫•y video, nh·∫°c li√™n quan ƒë·ªÉ ph√°t." }).catch((e) => { });
  });
  distube.on("searchCancel", async (queue) => {
    return await queue.textChannel?.send({ content: "T√¨m ki·∫øm b√†i h√°t b·ªã h·ªßy" }).catch((e) => { });
  });
  distube.on("finishSong", async (queue, song) => {
    const fetchChannel = queue.textChannel?.messages?.fetch(PlayerMap.get("idTextchannel"));
    const embed = new EmbedBuilders({
      author: { name: song.name, iconURL: "https://cdn.discordapp.com/attachments/883978730261860383/883978741892649000/847032838998196234.png", url: song.url },
      footer: { text: "üíØ BlackCat-Club\n‚õîÔ∏è B√†i h√°t ƒë√£ k·∫øt th√∫c!", iconURL: song.user?.displayAvatarURL({ dynamic: true }) },
      thumbnail: `https://img.youtube.com/vi/${song.id}/mqdefault.jpg`,
      colors: "Random"
    });
    return fetchChannel.then((msg) => msg.edit({ embeds: [embed], components: [] })).catch((ex) => { });
  });
  distube.on("disconnect", async (queue) => {
    return queue.textChannel?.send({ embeds: [new EmbedBuilders({ description: ":x: | ƒê√£ ng·∫Øt k·∫øt n·ªëi kh·ªèi k√™nh voice" })] }).catch((e) => { });
  });
  distube.on("empty", async (queue) => {
    return queue.textChannel?.send({ content: "K√™nh voice ch·ªëng. r·ªùi kh·ªèi k√™nh :))" }).catch((e) => { });
  });
  distube.on("error", async (channel, error) => {
    const embeds = new EmbedBuilders({ titlre: { name: "c√≥ l·ªói su·∫•t hi·ªán" }, description: `ƒê√£ x·∫£y ra l·ªói: ${error}`, colors: "Random" });
    return channel.send({ embeds: [embeds] }).catch((e) => { });
  });
  distube.on("searchNoResult", async (message) => {
    return message.channel.send({ content: "Kh√¥ng th·ªÉ t√¨m ki·∫øm b√†i h√°t" }).catch((e) => console.log(e));
  });
  distube.on("searchResult", async (message, results) => {
    let i = 0;
    return message.channel.send({ content: `**Ch·ªçn m·ªôt t√πy ch·ªçn t·ª´ b√™n d∆∞·ªõi**\n${results.map((song) => `**${++i}**. ${song.name} - \`${song.formattedDuration}\``).join("\n")}\n*Nh·∫≠p b·∫•t k·ª≥ th·ª© g√¨ kh√°c ho·∫∑c ƒë·ª£i 60 gi√¢y ƒë·ªÉ h·ªßy*` });
  });
  distube.on("searchInvalidAnswer", async () => { });
  distube.on("searchDone", async () => { });
};